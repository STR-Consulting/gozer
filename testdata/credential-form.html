{{define "credential-form" -}}
<div class="credential-form" id="credential-{{if .Credential}}{{.Credential.ID}}{{else}}new{{end}}">
    <form hx-{{if .IsEdit}}put{{else}}post{{end}}="/portfolio/{{.PortfolioID}}/credentials{{if .IsEdit}}/{{.Credential.ID}}{{end}}"
          hx-target="#credentials-list"
          hx-swap="innerHTML">

        <div class="form-row">
            <div class="form-group">
                <label for="platform-select">Platform</label>
                <select id="platform-select" name="platform" required onchange="applyPlatformDefaults(this)">
                    <option value="">-- Select Platform --</option>
                    {{range .Platforms -}}
                    <option value="{{.Name | lower}}"
                            data-credential-type="{{.CredentialType}}"
                            data-platform-type="{{.PlatformType}}"
                            data-required-keys="{{range $i, $k := .RequiredKeys}}{{if $i}},{{end}}{{$k}}{{end}}"
                            {{if and $.Credential (eq ($.Credential.Platform | lower) (.Name | lower))}}selected{{end}}>
                        {{.Name}} ({{.PlatformType | upper}})
                    </option>
                    {{- end -}}
                    <option value="other" {{if and $.Credential (not (platformKnown $.Credential.Platform))}}selected{{end}}>Other</option>
                </select>
            </div>
            <div class="form-group platform-custom{{if and .Credential (platformKnown .Credential.Platform)}} hidden{{end}}">
                <label for="platform-custom">Platform Name</label>
                <input type="text" id="platform-custom" name="platform_custom"
                       value="{{if and .Credential (not (platformKnown .Credential.Platform))}}{{.Credential.Platform}}{{end}}"
                       placeholder="e.g., pricelabs">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label for="platform-type">Platform Type</label>
                <select id="platform-type" name="platform_type">
                    <option value="">-- Select Type --</option>
                    <option value="pms" {{if and .Credential (eq .Credential.PlatformType "pms")}}selected{{end}}>PMS</option>
                    <option value="reporting" {{if and .Credential (eq .Credential.PlatformType "reporting")}}selected{{end}}>Reporting</option>
                    <option value="ps" {{if and .Credential (eq .Credential.PlatformType "ps")}}selected{{end}}>Pricing Solution</option>
                </select>
            </div>
            <div class="form-group">
                <label for="credential-type">Credential Type</label>
                <select id="credential-type" name="credential_type" required>
                    {{range .CredentialTypes -}}
                    <option value="{{.}}" {{if and $.Credential (eq $.Credential.CredentialType .)}}selected{{end}}>{{.}}</option>
                    {{- end -}}
                </select>
            </div>
        </div>
        <div class="form-group">
            <label for="credential-expires">Expires</label>
            <input type="date" id="credential-expires" name="expires_at"
                   value="{{if and .Credential .Credential.ExpiresAt}}{{.Credential.ExpiresAt.Format "2006-01-02"}}{{end}}">
        </div>

        <div class="secrets-section">
            <h4>Secrets</h4>
            <div class="secrets-list" id="secrets-list-{{if .Credential}}{{.Credential.ID}}{{else}}new{{end}}">
                {{if and .Credential .Credential.Secrets -}}
                {{range $key, $value := .Credential.Secrets -}}
                <div class="secret-row">
                    <select name="secret_key[]" required aria-label="Secret key">
                        {{range $.SecretKeys -}}
                        <option value="{{.}}" {{if eq $key (printf "%s" .)}}selected{{end}}>{{.Label}}</option>
                        {{- end -}}
                    </select>
                    <input type="password" name="secret_value[]" required value="{{$value}}" autocomplete="off" aria-label="Secret value">
                    <button type="button" class="btn btn-danger " title="Remove this secret" onclick="this.parentElement.remove()">Remove</button>
                </div>
                {{- end -}}
                {{- end -}}
            </div>
            <button type="button" class="btn btn-secondary " title="Add a new secret field" onclick="addSecretRow(this)">Add Secret</button>
        </div>

        {{if .Error -}}
        <div class="form-error">{{.Error}}</div>
        {{- end -}}

        <div class="form-actions">
            <button type="submit" class="btn btn-primary " title="{{if .IsEdit}}Update credential{{else}}Create credential{{end}}">{{if .IsEdit}}Update{{else}}Create{{end}}</button>
            <button type="button" class="btn btn-secondary " title="Cancel and return to list"
                    hx-get="/portfolio/{{.PortfolioID}}/credentials"
                    hx-target="#credentials-list"
                    hx-swap="innerHTML">Cancel</button>
        </div>
    </form>
</div>

<template id="secret-row-template">
    <div class="secret-row">
        <select name="secret_key[]" required aria-label="Secret key">
            {{range .SecretKeys -}}
            <option value="{{.}}">{{.Label}}</option>
            {{- end -}}
        </select>
        <input type="password" name="secret_value[]" required autocomplete="off" aria-label="Secret value">
        <button type="button" class="btn btn-danger " title="Remove this secret" onclick="this.parentElement.remove()">Remove</button>
    </div>
</template>

<script>
function applyPlatformDefaults(select) {
    const form = select.closest('.credential-form');
    const option = select.options[select.selectedIndex];
    const customField = form.querySelector('.platform-custom');
    const platformTypeSelect = form.querySelector('select[name="platform_type"]');
    const credentialTypeSelect = form.querySelector('select[name="credential_type"]');
    const secretsList = form.querySelector('.secrets-list');

    // Show/hide custom platform name field
    if (select.value === 'other' || select.value === '') {
        customField.classList.remove('hidden');
    } else {
        customField.classList.add('hidden');
        customField.querySelector('input').value = '';
    }

    // Apply presets from data attributes
    if (option.dataset.platformType) {
        platformTypeSelect.value = option.dataset.platformType;
    }
    if (option.dataset.credentialType) {
        credentialTypeSelect.value = option.dataset.credentialType;
    }

    // Add required secret rows if none exist
    const requiredKeys = option.dataset.requiredKeys;
    if (requiredKeys && secretsList.children.length === 0) {
        const keys = requiredKeys.split(',');
        for (const key of keys) {
            addSecretRowWithKey(form, key.trim());
        }
    }
}

function addSecretRow(btn) {
    const form = btn.closest('.credential-form');
    addSecretRowWithKey(form, '');
}

function addSecretRowWithKey(form, preselectedKey) {
    const list = form.querySelector('.secrets-list');
    const template = form.querySelector('#secret-row-template') || document.getElementById('secret-row-template');
    if (template) {
        const row = template.content.cloneNode(true);
        if (preselectedKey) {
            const select = row.querySelector('select');
            for (const opt of select.options) {
                if (opt.value === preselectedKey) {
                    opt.selected = true;
                    break;
                }
            }
        }
        list.appendChild(row);
    }
}
</script>
{{- end -}}
